---
phase: 03-catalog-backend
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/src/atlas/entrypoints/api/routes/catalog.py
autonomous: true

must_haves:
  truths:
    - "API returns single catalog item with documentation at GET /api/v1/catalog/{id}"
    - "Documentation is fetched from git repository (README.md in item's directory)"
    - "404 returned for non-existent item ID"
    - "Item detail includes all metadata fields plus documentation"
  artifacts:
    - path: "backend/src/atlas/entrypoints/api/routes/catalog.py"
      provides: "Detail endpoint with documentation retrieval"
      contains: "get_catalog_item"
  key_links:
    - from: "backend/src/atlas/entrypoints/api/routes/catalog.py"
      to: "backend/src/atlas/domain/interfaces/content_repository.py"
      via: "ContentRepo dependency"
      pattern: "content_repo.*get_content"
    - from: "backend/src/atlas/entrypoints/api/routes/catalog.py"
      to: "backend/src/atlas/domain/interfaces/catalog_repository.py"
      via: "CatalogRepo dependency for get_by_id"
      pattern: "catalog_repo.*get_by_id"
---

<objective>
Implement the catalog detail endpoint with documentation retrieval from git

Purpose: Enable viewing full documentation for any skill, MCP, or tool (CATL-06)
Output: Working GET /api/v1/catalog/{id} endpoint returning item metadata plus README content from git
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-catalog-backend/03-RESEARCH.md

# Prior plan summary (if exists)
@.planning/phases/03-catalog-backend/03-01-SUMMARY.md

# Existing files to modify
@backend/src/atlas/entrypoints/api/routes/catalog.py
@backend/src/atlas/entrypoints/dependencies.py
@backend/src/atlas/domain/interfaces/content_repository.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add detail endpoint with documentation retrieval</name>
  <files>
    backend/src/atlas/entrypoints/api/routes/catalog.py
  </files>
  <action>
Add the catalog item detail endpoint to the existing catalog.py routes file:

1. Add required imports at top of file:
   ```python
   from datetime import datetime
   from fastapi import HTTPException, status
   from atlas.entrypoints.dependencies import CatalogRepo, ContentRepo
   ```
   (CatalogRepo should already be imported; add ContentRepo)

2. Add CatalogItemDetail response model after CatalogItemSummary:
   ```python
   class CatalogItemDetail(BaseModel):
       """Detail view with full documentation from git."""
       id: UUID
       type: CatalogItemType
       name: str
       description: str
       git_path: str
       tags: list[str]
       author_id: UUID
       team_id: Optional[UUID]
       usage_count: int
       created_at: datetime
       updated_at: datetime
       documentation: str  # README content from git
   ```

3. Add helper function to derive README path:
   ```python
   def _get_readme_path(git_path: str) -> str:
       """
       Derive README path from item's git path.

       Convention: If item is at skills/my-skill/config.yaml,
       look for skills/my-skill/README.md
       """
       if "/" in git_path:
           directory = git_path.rsplit("/", 1)[0]
           return f"{directory}/README.md"
       return "README.md"
   ```

4. Add detail endpoint after list endpoint:
   ```python
   @router.get("/{item_id}", response_model=CatalogItemDetail)
   async def get_catalog_item(
       item_id: UUID,
       catalog_repo: CatalogRepo,
       content_repo: ContentRepo,
   ) -> CatalogItemDetail:
       """
       Get catalog item details including full documentation.

       Documentation is fetched from the git repository (README.md in item's directory).
       Returns 404 if item does not exist.

       - **item_id**: UUID of the catalog item
       """
       # Get metadata from database
       item = await catalog_repo.get_by_id(item_id)
       if item is None:
           raise HTTPException(
               status_code=status.HTTP_404_NOT_FOUND,
               detail="Catalog item not found",
           )

       # Attempt to fetch documentation from git
       readme_path = _get_readme_path(item.git_path)
       documentation = ""
       try:
           content = await content_repo.get_content(readme_path)
           if content is not None:
               documentation = content
       except Exception:
           # Log error but don't fail - documentation is optional
           # Item metadata is still valuable without docs
           pass

       return CatalogItemDetail(
           id=item.id,
           type=item.type,
           name=item.name,
           description=item.description,
           git_path=item.git_path,
           tags=item.tags,
           author_id=item.author_id,
           team_id=item.team_id,
           usage_count=item.usage_count,
           created_at=item.created_at,
           updated_at=item.updated_at,
           documentation=documentation,
       )
   ```

Note: The endpoint gracefully handles missing documentation - returns empty string rather than failing. This ensures the catalog is browsable even if git content is temporarily unavailable.
  </action>
  <verify>
    Run: `cd /Users/roysarfati/PycharmProjects/atlas/backend && uv run python -c "from atlas.entrypoints.api.routes.catalog import router, CatalogItemDetail; print('Detail endpoint OK')"` should print "Detail endpoint OK"
  </verify>
  <done>
    - CatalogItemDetail response model defined with documentation field
    - _get_readme_path helper function extracts directory from git_path
    - GET /{item_id} endpoint fetches item from catalog_repo
    - Documentation fetched from content_repo using README.md convention
    - 404 HTTPException raised for non-existent items
    - Documentation fetch failures handled gracefully (empty string)
  </done>
</task>

<task type="auto">
  <name>Task 2: Manual API verification for detail endpoint</name>
  <files>None (verification only)</files>
  <action>
Test the catalog detail endpoint manually:

1. Ensure development server is running:
   `cd /Users/roysarfati/PycharmProjects/atlas/backend && uv run uvicorn atlas.entrypoints.app:app --reload --port 8000`

2. Test 404 for non-existent item:
   `curl -s -w "\nHTTP Status: %{http_code}\n" http://localhost:8000/api/v1/catalog/00000000-0000-0000-0000-000000000000`
   Expected: HTTP Status: 404, body contains "Catalog item not found"

3. Test invalid UUID format:
   `curl -s -w "\nHTTP Status: %{http_code}\n" http://localhost:8000/api/v1/catalog/not-a-uuid`
   Expected: HTTP Status: 422 (validation error)

4. If catalog has items (from webhook sync), test with real ID:
   - First get an ID: `curl -s http://localhost:8000/api/v1/catalog | python -m json.tool | grep '"id"' | head -1`
   - Then fetch detail: `curl -s http://localhost:8000/api/v1/catalog/{id} | python -m json.tool`
   Expected: Full item detail with documentation field (may be empty if no README)

5. Check OpenAPI docs:
   Open http://localhost:8000/docs in browser
   Expected: GET /api/v1/catalog/{item_id} endpoint documented with UUID path parameter

6. Verify response schema in docs shows:
   - All CatalogItemDetail fields
   - documentation field as string type
   - created_at and updated_at as datetime
  </action>
  <verify>
    - 404 returned for non-existent UUID
    - 422 returned for invalid UUID format
    - Valid item returns CatalogItemDetail with documentation field
    - OpenAPI docs show the detail endpoint
  </verify>
  <done>
    - GET /api/v1/catalog/{item_id} endpoint functional
    - Returns 404 for non-existent items
    - Returns 422 for invalid UUID format
    - Returns full item detail with documentation for valid items
    - Documentation field present (empty string if no README in git)
    - Endpoint documented in OpenAPI
  </done>
</task>

</tasks>

<verification>
After completing all tasks:
1. `curl http://localhost:8000/api/v1/catalog/00000000-0000-0000-0000-000000000000` returns 404
2. `curl http://localhost:8000/api/v1/catalog/invalid` returns 422
3. Detail endpoint returns all CatalogItemDetail fields including documentation
4. OpenAPI docs at /docs show the detail endpoint with path parameter
5. Documentation is fetched from git (README.md in item's directory)
</verification>

<success_criteria>
- GET /api/v1/catalog/{item_id} endpoint exists and returns 200 for valid items
- Response includes all metadata fields plus documentation string
- 404 returned with "Catalog item not found" for non-existent IDs
- 422 returned for malformed UUID path parameters
- Documentation retrieved from git using README.md convention
- Git/documentation errors handled gracefully (returns empty string, not 500)
- Requirement CATL-06 (documentation for each item) fully addressed
</success_criteria>

<output>
After completion, create `.planning/phases/03-catalog-backend/03-02-SUMMARY.md`
</output>
