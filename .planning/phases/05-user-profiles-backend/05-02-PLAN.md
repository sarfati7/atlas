---
phase: 05-user-profiles-backend
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - backend/src/atlas/entrypoints/dependencies.py
  - backend/src/atlas/entrypoints/api/routes/profile.py
  - backend/src/atlas/entrypoints/api/routes/__init__.py
  - backend/src/atlas/entrypoints/app.py
autonomous: true
user_setup: []

must_haves:
  truths:
    - "GET /api/v1/profile/dashboard returns user dashboard data"
    - "GET /api/v1/profile/available-items returns catalog items accessible to user"
    - "GET /api/v1/profile/effective-configuration returns merged config with source breakdown"
    - "All profile endpoints require authentication via CurrentUser"
  artifacts:
    - path: "backend/src/atlas/entrypoints/api/routes/profile.py"
      provides: "Profile API routes"
      exports: ["router"]
    - path: "backend/src/atlas/entrypoints/dependencies.py"
      provides: "ProfileService dependency injection"
      contains: "get_user_profile_service"
  key_links:
    - from: "profile.py"
      to: "ProfileService"
      via: "dependency injection"
      pattern: "profile_service: ProfileService"
    - from: "dependencies.py"
      to: "UserProfileService"
      via: "get_user_profile_service provider"
      pattern: "def get_user_profile_service"
    - from: "app.py"
      to: "profile.router"
      via: "include_router"
      pattern: "include_router.*profile"
---

<objective>
Create REST API endpoints and dependency injection for user profile data

Purpose: Expose user dashboard, available items, and effective configuration through REST API endpoints. Wire up the UserProfileService through FastAPI dependency injection.

Output:
- 3 authenticated profile endpoints under /api/v1/profile
- ProfileService type alias in dependencies.py
- Router registered in app.py
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-user-profiles-backend/05-RESEARCH.md
@.planning/phases/05-user-profiles-backend/05-01-SUMMARY.md

# Prior art - route patterns
@backend/src/atlas/entrypoints/api/routes/configuration.py
@backend/src/atlas/entrypoints/api/routes/catalog.py

# Dependency injection patterns
@backend/src/atlas/entrypoints/dependencies.py

# App registration
@backend/src/atlas/entrypoints/app.py
@backend/src/atlas/entrypoints/api/routes/__init__.py

# Service from 05-01
@backend/src/atlas/application/services/user_profile_service.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add UserProfileService dependency injection</name>
  <files>backend/src/atlas/entrypoints/dependencies.py</files>
  <action>
Add dependency provider and type alias for UserProfileService.

**Add import:**
```python
from atlas.application.services import UserProfileService
```

**Add provider function (after get_configuration_service):**
```python
async def get_user_profile_service(
    user_repo: Annotated[AbstractUserRepository, Depends(get_user_repository)],
    team_repo: Annotated[AbstractTeamRepository, Depends(get_team_repository)],
    catalog_repo: Annotated[AbstractCatalogRepository, Depends(get_catalog_repository)],
    config_repo: Annotated[AbstractConfigurationRepository, Depends(get_configuration_repository)],
    content_repo: Annotated[AbstractContentRepository, Depends(get_content_repository)],
) -> UserProfileService:
    """Provide user profile service implementation."""
    return UserProfileService(
        user_repo=user_repo,
        team_repo=team_repo,
        catalog_repo=catalog_repo,
        config_repo=config_repo,
        content_repo=content_repo,
    )
```

**Add type alias (with other service aliases):**
```python
ProfileService = Annotated[UserProfileService, Depends(get_user_profile_service)]
```
  </action>
  <verify>
```bash
cd /Users/roysarfati/PycharmProjects/atlas/backend
python -c "
from atlas.entrypoints.dependencies import get_user_profile_service, ProfileService
print('get_user_profile_service:', get_user_profile_service)
print('ProfileService:', ProfileService)
"
```
  </verify>
  <done>get_user_profile_service provider and ProfileService type alias exist in dependencies.py</done>
</task>

<task type="auto">
  <name>Task 2: Create profile routes</name>
  <files>
    backend/src/atlas/entrypoints/api/routes/profile.py
    backend/src/atlas/entrypoints/api/routes/__init__.py
  </files>
  <action>
Create profile.py with 3 endpoints. Follow patterns from configuration.py.

**Imports:**
```python
from typing import Optional

from fastapi import APIRouter, HTTPException, Query, status
from pydantic import BaseModel

from atlas.application.services import UserNotFoundError
from atlas.domain.entities import CatalogItemType
from atlas.entrypoints.dependencies import CurrentUser, ProfileService
```

**Response Models:**
```python
class EffectiveConfigurationResponse(BaseModel):
    """Effective configuration with inheritance breakdown."""
    content: str
    org_applied: bool
    team_applied: bool
    user_applied: bool
```

**Router:**
```python
router = APIRouter(prefix="/profile", tags=["profile"])
```

**Endpoint 1: GET /dashboard**
```python
@router.get("/dashboard")
async def get_dashboard(
    current_user: CurrentUser,
    profile_service: ProfileService,
):
    """
    Get current user's dashboard data.

    Returns aggregated view of user's teams, available items count, and config status.
    """
    try:
        return await profile_service.get_dashboard(current_user.id)
    except UserNotFoundError:
        raise HTTPException(
            status_code=status.HTTP_404_NOT_FOUND,
            detail="User not found",
        )
```
Return type is UserDashboard (from service, Pydantic will serialize).

**Endpoint 2: GET /available-items**
```python
@router.get("/available-items")
async def get_available_items(
    current_user: CurrentUser,
    profile_service: ProfileService,
    type: Optional[CatalogItemType] = Query(default=None, description="Filter by item type"),
):
    """
    Get catalog items available to current user.

    Returns company-wide items plus items from user's teams.
    Optionally filter by type (skill, mcp, tool).
    """
    items = await profile_service.get_available_items(current_user.id)
    if type is not None:
        items = [i for i in items if i.type == type]
    return items
```
Return type is list[CatalogItemSummary].

**Endpoint 3: GET /effective-configuration**
```python
@router.get("/effective-configuration")
async def get_effective_configuration(
    current_user: CurrentUser,
    profile_service: ProfileService,
) -> EffectiveConfigurationResponse:
    """
    Get user's effective configuration with inheritance chain.

    Shows merged configuration from org -> team -> user levels.
    """
    config = await profile_service.get_effective_configuration(current_user.id)
    return EffectiveConfigurationResponse(
        content=config.content,
        org_applied=bool(config.org_content),
        team_applied=bool(config.team_content),
        user_applied=bool(config.user_content),
    )
```

**Update __init__.py:**
Add `from atlas.entrypoints.api.routes.profile import router as profile_router`
  </action>
  <verify>
```bash
cd /Users/roysarfati/PycharmProjects/atlas/backend
python -c "
from atlas.entrypoints.api.routes.profile import router
print('Profile router prefix:', router.prefix)
print('Routes:', [r.path for r in router.routes])
"
```
  </verify>
  <done>profile.py has 3 endpoints: /dashboard, /available-items, /effective-configuration. Router exported from __init__.py.</done>
</task>

<task type="auto">
  <name>Task 3: Register profile router in app</name>
  <files>backend/src/atlas/entrypoints/app.py</files>
  <action>
Add profile router to FastAPI app.

**Add import (with other route imports):**
```python
from atlas.entrypoints.api.routes.profile import router as profile_router
```

**Add include_router (after configuration router):**
```python
app.include_router(profile_router, prefix="/api/v1")
```
  </action>
  <verify>
```bash
cd /Users/roysarfati/PycharmProjects/atlas/backend
python -c "
from atlas.entrypoints.app import app
routes = [r.path for r in app.routes]
assert '/api/v1/profile/dashboard' in routes, 'Dashboard route missing'
assert '/api/v1/profile/available-items' in routes, 'Available items route missing'
assert '/api/v1/profile/effective-configuration' in routes, 'Effective config route missing'
print('All profile routes registered:')
for r in routes:
    if '/profile/' in r:
        print(f'  {r}')
"
```
  </verify>
  <done>Profile router registered in app with /api/v1 prefix. All 3 routes accessible.</done>
</task>

</tasks>

<verification>
```bash
cd /Users/roysarfati/PycharmProjects/atlas/backend

# Verify full import chain works
python -c "
from atlas.entrypoints.app import app

# Check routes exist
routes = [r.path for r in app.routes]
profile_routes = [r for r in routes if '/profile/' in r]
print(f'Profile routes ({len(profile_routes)}):')
for r in profile_routes:
    print(f'  {r}')

assert len(profile_routes) == 3, f'Expected 3 profile routes, got {len(profile_routes)}'
print('All profile routes verified')
"

# Run any existing tests
python -m pytest tests/ -v --tb=short 2>/dev/null || echo "Tests not configured - skipping"
```
</verification>

<success_criteria>
- GET /api/v1/profile/dashboard returns UserDashboard with user info, teams, counts
- GET /api/v1/profile/available-items returns list of CatalogItemSummary, supports ?type filter
- GET /api/v1/profile/effective-configuration returns EffectiveConfigurationResponse
- All endpoints require CurrentUser (401 without token)
- ProfileService type alias available for clean route signatures
- Router registered in app.py
</success_criteria>

<output>
After completion, create `.planning/phases/05-user-profiles-backend/05-02-SUMMARY.md`
</output>
