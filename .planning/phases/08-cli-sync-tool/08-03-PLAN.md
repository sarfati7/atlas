---
phase: 08-cli-sync-tool
plan: 03
type: execute
wave: 2
depends_on: ["08-01", "08-02"]
files_modified:
  - cli/src/atlas_cli/commands/sync.py
  - cli/src/atlas_cli/main.py
autonomous: true

must_haves:
  truths:
    - "User can sync configuration from Atlas to ~/.claude/CLAUDE.md"
    - "Sync is atomic (no partial writes on failure)"
    - "User sees 'Already up to date' if no changes"
    - "User can preview with --dry-run flag"
  artifacts:
    - path: "cli/src/atlas_cli/commands/sync.py"
      provides: "Sync command implementation"
      exports: ["sync"]
  key_links:
    - from: "cli/src/atlas_cli/commands/sync.py"
      to: "cli/src/atlas_cli/api/client.py"
      via: "fetches configuration from API"
      pattern: "create_client"
    - from: "cli/src/atlas_cli/commands/sync.py"
      to: "cli/src/atlas_cli/storage/files.py"
      via: "writes config atomically"
      pattern: "atomic_write"
    - from: "cli/src/atlas_cli/main.py"
      to: "cli/src/atlas_cli/commands/sync.py"
      via: "registers sync command"
      pattern: "app.command"
---

<objective>
Implement the sync command that fetches configuration from Atlas and writes it atomically to ~/.claude/CLAUDE.md.

Purpose: This is the core functionality of the CLI - syncing user's configuration from the platform to their local Claude instance.
Output: Working `atlas sync` command with --dry-run and --force flags.
</objective>

<execution_context>
@~/.claude/agents/gsd-executor.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/08-cli-sync-tool/08-RESEARCH.md
@.planning/phases/08-cli-sync-tool/08-01-SUMMARY.md
@.planning/phases/08-cli-sync-tool/08-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create sync command</name>
  <files>
    cli/src/atlas_cli/commands/sync.py
  </files>
  <action>
    Create the sync command following research patterns:

    Create `cli/src/atlas_cli/commands/sync.py`:

    ```python
    """Sync command - fetch configuration from Atlas and write locally."""

    import typer
    from rich.panel import Panel

    from atlas_cli.api.client import create_client
    from atlas_cli.console import console, error, success, info
    from atlas_cli.storage.credentials import is_authenticated
    from atlas_cli.storage.files import atomic_write, get_config_path, read_config


    def sync(
        dry_run: bool = typer.Option(
            False, "--dry-run", "-n", help="Show what would be synced without writing"
        ),
        force: bool = typer.Option(
            False, "--force", "-f", help="Overwrite even if local content differs"
        ),
    ) -> None:
        """Sync configuration from Atlas to local ~/.claude/CLAUDE.md."""
        # Check authentication first
        if not is_authenticated():
            error("Not logged in. Run 'atlas auth login' first.")
            raise typer.Exit(1)

        config_path = get_config_path()

        # Fetch remote configuration
        with console.status("Fetching configuration from Atlas..."):
            try:
                with create_client() as client:
                    response = client.get("/configuration/me")
                    response.raise_for_status()

                data = response.json()
                remote_content = data.get("content", "")
                remote_sha = data.get("commit_sha", "unknown")

            except Exception as e:
                error(f"Failed to fetch configuration: {e}")
                raise typer.Exit(1)

        # Check if empty configuration
        if not remote_content.strip():
            info("No configuration found on Atlas. Nothing to sync.")
            info("Create your configuration at the Atlas web interface first.")
            return

        # Check if already synced
        local_content = read_config()
        if local_content is not None and local_content == remote_content:
            success("Already up to date.")
            info(f"Commit: {remote_sha[:7]}")
            return

        # Show diff summary
        if local_content is not None and not force:
            console.print(f"\n[yellow]Local file will be updated:[/yellow] {config_path}")
            console.print(f"[dim]Remote commit: {remote_sha[:7]}[/dim]")

        # Dry run - just show what would happen
        if dry_run:
            console.print(Panel(
                f"Would write {len(remote_content)} bytes to {config_path}\n"
                f"Commit: {remote_sha[:7]}",
                title="[cyan]Dry Run[/cyan]",
                border_style="cyan",
            ))
            return

        # Perform atomic write
        with console.status("Writing configuration..."):
            try:
                atomic_write(config_path, remote_content)
            except Exception as e:
                error(f"Failed to write configuration: {e}")
                raise typer.Exit(1)

        success(f"Synced configuration to {config_path}")
        info(f"Commit: {remote_sha[:7]}")
    ```
  </action>
  <verify>
    python -c "from atlas_cli.commands.sync import sync; print('sync command loaded')"
  </verify>
  <done>
    Sync command fetches from API and writes atomically with dry-run support
  </done>
</task>

<task type="auto">
  <name>Task 2: Register sync command in main.py</name>
  <files>
    cli/src/atlas_cli/main.py
  </files>
  <action>
    Update `cli/src/atlas_cli/main.py` to register the sync command:

    Add import at top:
    ```python
    from atlas_cli.commands.sync import sync
    ```

    Add command registration after auth registration:
    ```python
    # Register commands
    app.add_typer(auth.app, name="auth")
    app.command()(sync)
    ```
  </action>
  <verify>
    atlas sync --help
  </verify>
  <done>
    `atlas sync --help` shows sync command with --dry-run and --force options
  </done>
</task>

<task type="auto">
  <name>Task 3: Test sync flow</name>
  <files>
    None (verification only)
  </files>
  <action>
    Test the sync command:

    1. Without auth: `atlas sync` should show "Not logged in" error

    2. After login: `atlas sync --dry-run` should show what would be synced

    3. Full sync: `atlas sync` should:
       - Fetch configuration from API
       - Write to ~/.claude/CLAUDE.md atomically
       - Show success message with commit SHA

    4. Second sync: `atlas sync` should show "Already up to date"

    5. Force sync: `atlas sync --force` should overwrite even if same

    Note: If backend unavailable, verify command structure is correct.
  </action>
  <verify>
    atlas sync --help
  </verify>
  <done>
    Sync command works correctly with all flags
  </done>
</task>

</tasks>

<verification>
All checks pass:
- `atlas sync --help` shows available options
- Sync fetches from /configuration/me endpoint
- Writes atomically using temp file + rename pattern
- --dry-run shows preview without writing
- Reports "Already up to date" when unchanged
</verification>

<success_criteria>
1. Sync command fetches configuration from Atlas API
2. Configuration written atomically (no partial writes)
3. --dry-run flag previews without writing
4. Reports "Already up to date" when no changes
5. Requires authentication (shows helpful error if not logged in)
6. Shows commit SHA for traceability
</success_criteria>

<output>
After completion, create `.planning/phases/08-cli-sync-tool/08-03-SUMMARY.md`
</output>
