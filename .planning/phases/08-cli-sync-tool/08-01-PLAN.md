---
phase: 08-cli-sync-tool
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - cli/pyproject.toml
  - cli/src/atlas_cli/__init__.py
  - cli/src/atlas_cli/main.py
  - cli/src/atlas_cli/console.py
  - cli/src/atlas_cli/storage/__init__.py
  - cli/src/atlas_cli/storage/credentials.py
  - cli/src/atlas_cli/storage/files.py
autonomous: true

must_haves:
  truths:
    - "CLI package installs with `uv pip install -e .`"
    - "Running `atlas` shows help message"
    - "Credentials can be stored and retrieved from OS keychain"
    - "Files can be written atomically (no partial writes)"
  artifacts:
    - path: "cli/pyproject.toml"
      provides: "Package definition with Typer, httpx, keyring, rich dependencies"
      contains: "[project.scripts]"
    - path: "cli/src/atlas_cli/main.py"
      provides: "Typer app entry point"
      exports: ["app", "main"]
    - path: "cli/src/atlas_cli/storage/credentials.py"
      provides: "Keyring wrapper for secure token storage"
      exports: ["save_tokens", "get_access_token", "get_refresh_token", "clear_tokens"]
    - path: "cli/src/atlas_cli/storage/files.py"
      provides: "Atomic file write utility"
      exports: ["atomic_write", "get_claude_dir", "get_config_path"]
  key_links:
    - from: "cli/pyproject.toml"
      to: "cli/src/atlas_cli/main.py"
      via: "project.scripts entry point"
      pattern: "atlas = \"atlas_cli.main:main\""
---

<objective>
Create CLI project structure with storage utilities for credentials and atomic file writes.

Purpose: Establish the foundational CLI package that can be installed and provides secure credential storage via OS keychain plus atomic file operations for safe config syncing.
Output: Installable CLI package with `atlas` command and reusable storage modules.
</objective>

<execution_context>
@~/.claude/agents/gsd-executor.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-cli-sync-tool/08-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: CLI project setup with pyproject.toml and package structure</name>
  <files>
    cli/pyproject.toml
    cli/src/atlas_cli/__init__.py
    cli/src/atlas_cli/main.py
    cli/src/atlas_cli/console.py
    cli/src/atlas_cli/commands/__init__.py
    cli/src/atlas_cli/api/__init__.py
    cli/src/atlas_cli/storage/__init__.py
  </files>
  <action>
    Create the CLI project structure following the research pattern:

    1. Create `cli/pyproject.toml`:
       - name: "atlas-cli"
       - version: "0.1.0"
       - requires-python: ">=3.12"
       - dependencies: typer>=0.9.0, httpx>=0.27.0, keyring>=25.0.0, rich>=14.0.0
       - dev dependencies: pytest>=8.0.0, pytest-httpx>=0.30.0
       - entry point: atlas = "atlas_cli.main:main"
       - build system: hatchling with packages = ["src/atlas_cli"]

    2. Create `cli/src/atlas_cli/__init__.py`:
       - __version__ = "0.1.0"

    3. Create `cli/src/atlas_cli/main.py`:
       - Import typer
       - Create Typer app with name="atlas", help="Sync Claude configuration from Atlas platform", no_args_is_help=True
       - Define main() function that calls app()
       - Add placeholder for future command registrations (comments)

    4. Create `cli/src/atlas_cli/console.py`:
       - Import Console from rich.console
       - Create shared console = Console() instance
       - Helper functions: info(msg), success(msg), error(msg), warning(msg)
         - These wrap console.print with appropriate color styles

    5. Create empty __init__.py files for commands/, api/, storage/ directories
  </action>
  <verify>
    cd /Users/roysarfati/PycharmProjects/atlas/cli && uv pip install -e . && atlas --help
  </verify>
  <done>
    `atlas --help` shows "Sync Claude configuration from Atlas platform" help text
  </done>
</task>

<task type="auto">
  <name>Task 2: Keyring credential storage module</name>
  <files>
    cli/src/atlas_cli/storage/credentials.py
  </files>
  <action>
    Create keyring wrapper for secure credential storage:

    1. Define SERVICE_NAME = "atlas-cli" constant

    2. Implement save_tokens(access_token: str, refresh_token: str) -> None:
       - keyring.set_password(SERVICE_NAME, "access_token", access_token)
       - keyring.set_password(SERVICE_NAME, "refresh_token", refresh_token)

    3. Implement get_access_token() -> str | None:
       - return keyring.get_password(SERVICE_NAME, "access_token")

    4. Implement get_refresh_token() -> str | None:
       - return keyring.get_password(SERVICE_NAME, "refresh_token")

    5. Implement clear_tokens() -> None:
       - Try to delete both tokens, catch and ignore keyring.errors.PasswordDeleteError
       - This allows calling clear even when no tokens exist

    6. Implement is_authenticated() -> bool:
       - Return True if get_access_token() is not None

    All functions should have proper type hints and docstrings.
  </action>
  <verify>
    python -c "from atlas_cli.storage.credentials import save_tokens, get_access_token, clear_tokens; save_tokens('test', 'test'); assert get_access_token() == 'test'; clear_tokens(); assert get_access_token() is None; print('OK')"
  </verify>
  <done>
    Credentials can be saved to keyring, retrieved, and cleared successfully
  </done>
</task>

<task type="auto">
  <name>Task 3: Atomic file write module</name>
  <files>
    cli/src/atlas_cli/storage/files.py
  </files>
  <action>
    Create atomic file write utilities for safe configuration syncing:

    1. Import os, tempfile from stdlib, Path from pathlib

    2. Implement get_claude_dir() -> Path:
       - Return Path.home() / ".claude"
       - This is cross-platform (works on Windows, macOS, Linux)

    3. Implement get_config_path() -> Path:
       - Return get_claude_dir() / "CLAUDE.md"

    4. Implement atomic_write(path: Path, content: str) -> None:
       - Ensure parent directory exists: path.parent.mkdir(parents=True, exist_ok=True)
       - Create temp file in same directory (for atomic rename):
         fd, tmp_path = tempfile.mkstemp(dir=path.parent, prefix=".tmp_", suffix=path.suffix or ".md")
       - Write content with proper encoding and flush:
         with os.fdopen(fd, "w", encoding="utf-8") as f:
             f.write(content)
             f.flush()
             os.fsync(f.fileno())  # Ensure written to disk
       - Atomic rename: os.replace(tmp_path, path)
       - In except block: clean up temp file with os.unlink(tmp_path), then re-raise

    5. Implement read_config() -> str | None:
       - If get_config_path().exists(), return its text content
       - Else return None

    All functions should have proper type hints and docstrings.
  </action>
  <verify>
    python -c "from atlas_cli.storage.files import atomic_write, get_config_path, read_config; from pathlib import Path; import tempfile; p = Path(tempfile.gettempdir()) / 'test_atomic.md'; atomic_write(p, 'test content'); assert p.read_text() == 'test content'; p.unlink(); print('OK')"
  </verify>
  <done>
    atomic_write creates file atomically (no partial writes on interrupt)
  </done>
</task>

</tasks>

<verification>
All checks pass:
- `atlas --help` shows CLI help
- Keyring storage works for tokens
- Atomic file write creates files safely
</verification>

<success_criteria>
1. CLI package installs cleanly with `uv pip install -e .`
2. `atlas` command is available and shows help
3. Credential storage works via OS keychain (macOS Keychain, Windows Credential Manager, Linux Secret Service)
4. Atomic file write uses temp file + rename pattern for safety
</success_criteria>

<output>
After completion, create `.planning/phases/08-cli-sync-tool/08-01-SUMMARY.md`
</output>
