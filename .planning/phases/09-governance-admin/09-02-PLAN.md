---
phase: 09-governance-admin
plan: 02
type: execute
wave: 2
depends_on: ["09-01"]
files_modified:
  - backend/src/atlas/adapters/authorization/rbac.py
  - backend/src/atlas/adapters/authorization/__init__.py
  - backend/src/atlas/entrypoints/dependencies.py
  - backend/src/atlas/entrypoints/api/routes/admin_teams.py
  - backend/src/atlas/entrypoints/api/routes/__init__.py
  - backend/src/atlas/entrypoints/app.py
autonomous: true

must_haves:
  truths:
    - "Admin can create new teams via API"
    - "Admin can edit team names via API"
    - "Admin can delete teams via API"
    - "Admin can add users to teams via API"
    - "Admin can remove users from teams via API"
    - "Non-admin users receive 403 when accessing admin endpoints"
  artifacts:
    - path: "backend/src/atlas/adapters/authorization/rbac.py"
      provides: "Role-based authorization service"
      contains: "class RBACAuthorizationService"
    - path: "backend/src/atlas/entrypoints/api/routes/admin_teams.py"
      provides: "Team management API endpoints"
      exports: ["router"]
  key_links:
    - from: "backend/src/atlas/entrypoints/api/routes/admin_teams.py"
      to: "RBACAuthorizationService"
      via: "dependency injection"
      pattern: "AuthorizationSvc|require_admin"
    - from: "backend/src/atlas/entrypoints/dependencies.py"
      to: "RBACAuthorizationService"
      via: "get_authorization_service"
      pattern: "RBACAuthorizationService"
---

<objective>
Implement RBAC authorization service and team management API endpoints

Purpose: Enable admins to manage teams through the API with proper role enforcement
Output: RBACAuthorizationService replacing permissive, /api/v1/admin/teams endpoints
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/09-governance-admin/09-01-SUMMARY.md
@backend/src/atlas/adapters/authorization/permissive.py
@backend/src/atlas/adapters/authorization/interface.py
@backend/src/atlas/entrypoints/dependencies.py
@backend/src/atlas/domain/entities/team.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement RBACAuthorizationService</name>
  <files>
    backend/src/atlas/adapters/authorization/rbac.py
    backend/src/atlas/adapters/authorization/__init__.py
    backend/src/atlas/entrypoints/dependencies.py
  </files>
  <action>
1. Create rbac.py with RBACAuthorizationService implementing AbstractAuthorizationService:
   - is_admin(user): return user.role == UserRole.ADMIN
   - require_admin(user): raise HTTPException(403) if not admin
   - can_manage_users(user): return is_admin(user)
   - can_view_item(user, item): return True (all users can view catalog)
   - can_edit_item(user, item): return is_admin(user)
   - can_delete_item(user, item): return is_admin(user)
   - can_create_item(user): return is_admin(user)
   - can_manage_team(user, team_id): return is_admin(user)
   - can_view_team(user, team_id): return True (all users can view teams)

2. Export RBACAuthorizationService from __init__.py

3. Update dependencies.py:
   - Change get_authorization_service() to return RBACAuthorizationService()
   - Add RequireAdmin dependency that calls auth_service.require_admin(current_user)
  </action>
  <verify>
    cd /Users/roysarfati/PycharmProjects/atlas/backend && uv run python -c "from atlas.adapters.authorization import RBACAuthorizationService; from atlas.domain.entities import User; from atlas.domain.entities.user import UserRole; import asyncio; svc = RBACAuthorizationService(); admin = User(email='a@a.com', username='admin', role=UserRole.ADMIN); user = User(email='u@u.com', username='user'); print(asyncio.run(svc.is_admin(admin)), asyncio.run(svc.is_admin(user)))"
  </verify>
  <done>RBACAuthorizationService correctly checks user roles, dependencies updated</done>
</task>

<task type="auto">
  <name>Task 2: Create team management API endpoints</name>
  <files>
    backend/src/atlas/entrypoints/api/routes/admin_teams.py
    backend/src/atlas/entrypoints/api/routes/__init__.py
    backend/src/atlas/entrypoints/app.py
  </files>
  <action>
1. Create admin_teams.py with router at prefix "/api/v1/admin/teams":
   - All endpoints require CurrentUser and call RequireAdmin dependency

   Endpoints:
   - GET / - List all teams (paginated)
     Response: { items: Team[], total: int, page: int, page_size: int }

   - POST / - Create team
     Request: { name: str }
     Response: Team (201)
     Error: 409 if name exists

   - GET /{team_id} - Get team details with members
     Response: { team: Team, members: User[] }
     Error: 404 if not found

   - PUT /{team_id} - Update team
     Request: { name: str }
     Response: Team
     Error: 404 if not found, 409 if name collision

   - DELETE /{team_id} - Delete team
     Response: 204 No Content
     Error: 404 if not found

   - POST /{team_id}/members - Add user to team
     Request: { user_id: UUID }
     Response: Team (with updated member list)
     Error: 404 if team/user not found

   - DELETE /{team_id}/members/{user_id} - Remove user from team
     Response: 204 No Content
     Error: 404 if team/user not found

2. Add router export to routes/__init__.py

3. Register router in app.py under /api/v1/admin/teams prefix
  </action>
  <verify>
    cd /Users/roysarfati/PycharmProjects/atlas/backend && uv run python -c "from atlas.entrypoints.api.routes.admin_teams import router; print([r.path for r in router.routes])"
  </verify>
  <done>All team management endpoints exist with proper request/response schemas</done>
</task>

<task type="auto">
  <name>Task 3: Add audit logging to team operations</name>
  <files>
    backend/src/atlas/entrypoints/api/routes/admin_teams.py
  </files>
  <action>
1. In each mutation endpoint (POST, PUT, DELETE), create audit log entry:
   - Import AuditLog from domain.entities
   - After successful operation, create AuditLog with:
     - user_id: current_user.id
     - action: "team.created" | "team.updated" | "team.deleted" | "team.member_added" | "team.member_removed"
     - resource_type: "team"
     - resource_id: team.id
     - details: { relevant context like old_name/new_name, user_id for member changes }
   - Save via repo.save_audit_log(log)

2. Ensure audit logging doesn't break the main operation (wrap in try/except, log errors but don't fail request)
  </action>
  <verify>
    cd /Users/roysarfati/PycharmProjects/atlas/backend && uv run python -c "from atlas.entrypoints.api.routes.admin_teams import router; import inspect; src = inspect.getsource(router.routes[1].endpoint); print('save_audit_log' in src or 'AuditLog' in src)"
  </verify>
  <done>All team mutation endpoints create audit log entries</done>
</task>

</tasks>

<verification>
1. RBAC works: Create admin and regular user, verify admin can access endpoints, regular user gets 403
2. Team CRUD:
   - POST /api/v1/admin/teams creates team
   - GET /api/v1/admin/teams lists teams
   - PUT /api/v1/admin/teams/{id} updates team
   - DELETE /api/v1/admin/teams/{id} deletes team
3. Member management:
   - POST /api/v1/admin/teams/{id}/members adds user
   - DELETE /api/v1/admin/teams/{id}/members/{user_id} removes user
4. Audit logs: After operations, verify audit_logs table has entries
</verification>

<success_criteria>
- RBACAuthorizationService correctly returns True/False based on user.role
- Non-admin users receive 403 Forbidden on admin endpoints
- All 7 team management endpoints functional
- Each mutation creates audit log entry
- Team name uniqueness enforced (409 on conflict)
</success_criteria>

<output>
After completion, create `.planning/phases/09-governance-admin/09-02-SUMMARY.md`
</output>
