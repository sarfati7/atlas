---
phase: 09-governance-admin
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/src/atlas/domain/entities/user.py
  - backend/src/atlas/domain/entities/audit_log.py
  - backend/src/atlas/domain/entities/__init__.py
  - backend/src/atlas/adapters/repository/models.py
  - backend/src/atlas/adapters/repository/interface.py
  - backend/src/atlas/adapters/repository/postgresql.py
  - backend/src/atlas/adapters/authorization/interface.py
  - backend/alembic/versions/003_add_role_and_audit_log.py
autonomous: true

must_haves:
  truths:
    - "User entity has role field distinguishing admin from regular user"
    - "AuditLog entity captures who, what, when for all changes"
    - "Database schema supports role and audit logs"
    - "Authorization interface has role-checking methods"
  artifacts:
    - path: "backend/src/atlas/domain/entities/user.py"
      provides: "User entity with role field"
      contains: "role: UserRole"
    - path: "backend/src/atlas/domain/entities/audit_log.py"
      provides: "AuditLog entity for tracking changes"
      contains: "class AuditLog"
    - path: "backend/src/atlas/adapters/repository/models.py"
      provides: "SQLModel tables for role and audit logs"
      contains: "AuditLogModel"
    - path: "backend/alembic/versions/003_add_role_and_audit_log.py"
      provides: "Database migration for new schema"
      contains: "def upgrade"
  key_links:
    - from: "backend/src/atlas/adapters/repository/postgresql.py"
      to: "AuditLogModel"
      via: "repository methods"
      pattern: "save_audit_log|get_audit_logs"
    - from: "backend/src/atlas/adapters/authorization/interface.py"
      to: "User.role"
      via: "role check methods"
      pattern: "is_admin|require_admin"
---

<objective>
Add role-based user model and audit logging domain layer with database migration

Purpose: Foundation for all governance features - distinguishes admins from regular users and enables change tracking
Output: User entity with role, AuditLog entity, extended repository interface, Alembic migration
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@backend/src/atlas/domain/entities/user.py
@backend/src/atlas/adapters/repository/models.py
@backend/src/atlas/adapters/repository/interface.py
@backend/src/atlas/adapters/repository/postgresql.py
@backend/src/atlas/adapters/authorization/interface.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add role to User entity and create AuditLog entity</name>
  <files>
    backend/src/atlas/domain/entities/user.py
    backend/src/atlas/domain/entities/audit_log.py
    backend/src/atlas/domain/entities/__init__.py
  </files>
  <action>
1. In user.py, add UserRole enum (StrEnum with values "admin" and "user") and add role field:
   - `role: UserRole = Field(default=UserRole.USER)`
   - Add `is_admin` property that returns `self.role == UserRole.ADMIN`

2. Create audit_log.py with AuditLog entity (Pydantic BaseModel):
   - id: UUID (default_factory=uuid4)
   - user_id: UUID (who made the change)
   - action: str (e.g., "user.created", "team.updated", "config.saved")
   - resource_type: str (e.g., "user", "team", "configuration")
   - resource_id: UUID (what was changed)
   - details: dict (JSON blob with before/after or additional context)
   - created_at: datetime

3. Export AuditLog from entities/__init__.py
  </action>
  <verify>
    cd /Users/roysarfati/PycharmProjects/atlas/backend && uv run python -c "from atlas.domain.entities import User, AuditLog; from atlas.domain.entities.user import UserRole; print(UserRole.ADMIN, UserRole.USER)"
  </verify>
  <done>User has role field with UserRole enum, AuditLog entity exists with all fields</done>
</task>

<task type="auto">
  <name>Task 2: Update database models and repository interface</name>
  <files>
    backend/src/atlas/adapters/repository/models.py
    backend/src/atlas/adapters/repository/interface.py
    backend/src/atlas/adapters/repository/postgresql.py
  </files>
  <action>
1. In models.py:
   - Add `role: str = Field(default="user")` to UserModel
   - Create AuditLogModel table with columns matching AuditLog entity
   - Use JSON column type for details field

2. In interface.py, add audit log methods to AbstractRepository:
   - `async def save_audit_log(self, log: AuditLog) -> AuditLog`
   - `async def get_audit_logs(self, resource_type: Optional[str] = None, resource_id: Optional[UUID] = None, user_id: Optional[UUID] = None, limit: int = 100, offset: int = 0) -> list[AuditLog]`
   - `async def count_audit_logs(self, resource_type: Optional[str] = None, resource_id: Optional[UUID] = None, user_id: Optional[UUID] = None) -> int`

3. In postgresql.py, implement the new methods:
   - save_audit_log: insert into audit_logs table
   - get_audit_logs: select with optional filters, order by created_at DESC
   - count_audit_logs: count with same filters
   - Update user save/get methods to handle role field
  </action>
  <verify>
    cd /Users/roysarfati/PycharmProjects/atlas/backend && uv run python -c "from atlas.adapters.repository import AbstractRepository; print([m for m in dir(AbstractRepository) if 'audit' in m])"
  </verify>
  <done>Repository interface has audit log methods, PostgreSQL implementation complete</done>
</task>

<task type="auto">
  <name>Task 3: Create Alembic migration and extend authorization interface</name>
  <files>
    backend/alembic/versions/003_add_role_and_audit_log.py
    backend/src/atlas/adapters/authorization/interface.py
  </files>
  <action>
1. Create migration 003_add_role_and_audit_log.py:
   - Add role column to users table (VARCHAR, default 'user', NOT NULL)
   - Create audit_logs table with columns: id (UUID PK), user_id (UUID FK to users), action (VARCHAR), resource_type (VARCHAR), resource_id (UUID), details (JSONB), created_at (TIMESTAMP)
   - Add index on audit_logs(resource_type, resource_id)
   - Add index on audit_logs(user_id)
   - Add index on audit_logs(created_at DESC)

2. In authorization/interface.py, add role-checking methods:
   - `async def is_admin(self, user: User) -> bool` - check if user has admin role
   - `async def require_admin(self, user: User) -> None` - raise AuthorizationError if not admin
   - `async def can_manage_users(self, user: User) -> bool` - check if user can manage other users
  </action>
  <verify>
    cd /Users/roysarfati/PycharmProjects/atlas/backend && uv run alembic upgrade head && uv run alembic current
  </verify>
  <done>Migration creates role column and audit_logs table, authorization interface has role methods</done>
</task>

</tasks>

<verification>
1. User entity has role field: `uv run python -c "from atlas.domain.entities import User; u = User(email='test@test.com', username='test'); print(u.role, u.is_admin)"`
2. AuditLog entity exists: `uv run python -c "from atlas.domain.entities import AuditLog; print(AuditLog.__fields__.keys())"`
3. Database migration applied: `uv run alembic current` shows 003
4. Repository methods exist: `uv run python -c "from atlas.adapters.repository import AbstractRepository; print('save_audit_log' in dir(AbstractRepository))"`
</verification>

<success_criteria>
- User entity has role field with UserRole enum (admin/user)
- User.is_admin property returns correct boolean
- AuditLog entity captures user_id, action, resource_type, resource_id, details, created_at
- Database has role column on users table
- Database has audit_logs table with indexes
- Repository interface has save_audit_log, get_audit_logs, count_audit_logs methods
- Authorization interface has is_admin, require_admin, can_manage_users methods
</success_criteria>

<output>
After completion, create `.planning/phases/09-governance-admin/09-01-SUMMARY.md`
</output>
