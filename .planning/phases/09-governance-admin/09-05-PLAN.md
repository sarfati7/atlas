---
phase: 09-governance-admin
plan: 05
type: execute
wave: 3
depends_on: ["09-02", "09-03"]
files_modified:
  - backend/src/atlas/domain/entities/usage_event.py
  - backend/src/atlas/domain/entities/__init__.py
  - backend/src/atlas/adapters/repository/models.py
  - backend/src/atlas/adapters/repository/interface.py
  - backend/src/atlas/adapters/repository/postgresql.py
  - backend/src/atlas/entrypoints/api/routes/admin_analytics.py
  - backend/src/atlas/entrypoints/app.py
  - backend/alembic/versions/004_add_usage_events.py
  - frontend/src/features/admin/api/index.ts
  - frontend/src/features/admin/hooks/index.ts
  - frontend/src/features/admin/components/UsageChart.tsx
  - frontend/src/features/admin/components/AuditLogList.tsx
  - frontend/src/pages/AdminAnalytics.tsx
  - frontend/src/pages/AdminAuditLogs.tsx
  - frontend/src/router.tsx
autonomous: false

must_haves:
  truths:
    - "Admin can view usage analytics showing tool/skill usage"
    - "Admin can filter analytics by date range"
    - "Admin can view audit log list with filtering"
    - "Admin can see who used which tools and when"
  artifacts:
    - path: "backend/src/atlas/domain/entities/usage_event.py"
      provides: "UsageEvent entity for tracking tool usage"
      contains: "class UsageEvent"
    - path: "backend/src/atlas/entrypoints/api/routes/admin_analytics.py"
      provides: "Analytics API endpoints"
      exports: ["router"]
    - path: "frontend/src/pages/AdminAnalytics.tsx"
      provides: "Analytics dashboard page"
      contains: "UsageChart"
    - path: "frontend/src/pages/AdminAuditLogs.tsx"
      provides: "Audit log viewer page"
      contains: "AuditLogList"
  key_links:
    - from: "frontend/src/pages/AdminAnalytics.tsx"
      to: "/api/v1/admin/analytics"
      via: "API calls"
      pattern: "api/v1/admin/analytics"
---

<objective>
Build usage analytics tracking and audit log viewer

Purpose: Give admins visibility into tool usage and system-wide change history
Output: UsageEvent entity, analytics API, analytics dashboard, audit log viewer UI
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/09-governance-admin/09-01-SUMMARY.md
@.planning/phases/09-governance-admin/09-03-SUMMARY.md
@backend/src/atlas/domain/entities/audit_log.py
@frontend/src/features/admin/types.ts
@frontend/src/features/admin/hooks/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create usage events domain layer and database</name>
  <files>
    backend/src/atlas/domain/entities/usage_event.py
    backend/src/atlas/domain/entities/__init__.py
    backend/src/atlas/adapters/repository/models.py
    backend/src/atlas/adapters/repository/interface.py
    backend/src/atlas/adapters/repository/postgresql.py
    backend/alembic/versions/004_add_usage_events.py
  </files>
  <action>
1. Create usage_event.py with UsageEvent entity (Pydantic BaseModel):
   - id: UUID
   - user_id: UUID (who used the tool)
   - item_id: UUID (which catalog item was used)
   - item_type: CatalogItemType (SKILL/MCP/TOOL)
   - action: str (e.g., "sync", "view", "execute")
   - metadata: dict (optional context)
   - created_at: datetime

2. Export from entities/__init__.py

3. Add UsageEventModel to models.py with appropriate columns

4. Add to interface.py:
   - save_usage_event(event) -> UsageEvent
   - get_usage_events(user_id?, item_id?, item_type?, start_date?, end_date?, limit, offset) -> list[UsageEvent]
   - get_usage_stats(start_date?, end_date?, group_by: "user"|"item"|"day") -> list[UsageStat]
     UsageStat: { key: str, count: int, item_type?: str }

5. Implement in postgresql.py

6. Create migration 004_add_usage_events.py:
   - Create usage_events table
   - Add indexes on user_id, item_id, created_at
  </action>
  <verify>
    cd /Users/roysarfati/PycharmProjects/atlas/backend && uv run alembic upgrade head && uv run python -c "from atlas.domain.entities import UsageEvent; print(UsageEvent.__fields__.keys())"
  </verify>
  <done>UsageEvent entity exists, database table created, repository methods implemented</done>
</task>

<task type="auto">
  <name>Task 2: Create analytics API endpoints</name>
  <files>
    backend/src/atlas/entrypoints/api/routes/admin_analytics.py
    backend/src/atlas/entrypoints/api/routes/__init__.py
    backend/src/atlas/entrypoints/app.py
  </files>
  <action>
1. Create admin_analytics.py with router at "/api/v1/admin/analytics":

   Endpoints (all require admin):
   - GET /summary - Get overall usage summary
     Query: start_date?, end_date?
     Response: { total_users: int, total_syncs: int, active_users_period: int, most_used_items: [{item_id, name, type, count}] }

   - GET /usage-by-user - Usage grouped by user
     Query: start_date?, end_date?, limit (default 20)
     Response: { items: [{user_id, email, username, sync_count, last_sync}] }

   - GET /usage-by-item - Usage grouped by catalog item
     Query: start_date?, end_date?, item_type?, limit
     Response: { items: [{item_id, name, type, usage_count}] }

   - GET /usage-timeline - Usage over time
     Query: start_date?, end_date?, granularity ("day"|"week"|"month")
     Response: { items: [{date: str, count: int}] }

   - POST /events - Record usage event (for CLI/future integrations)
     Request: { item_id: UUID, action: str, metadata?: dict }
     Response: UsageEvent (201)
     Note: Uses CurrentUser to set user_id

2. Register router in app.py
  </action>
  <verify>
    cd /Users/roysarfati/PycharmProjects/atlas/backend && uv run python -c "from atlas.entrypoints.api.routes.admin_analytics import router; print([r.path for r in router.routes])"
  </verify>
  <done>Analytics API endpoints created with summary, groupings, and timeline</done>
</task>

<task type="auto">
  <name>Task 3: Create analytics dashboard and audit log UI</name>
  <files>
    frontend/src/features/admin/types.ts
    frontend/src/features/admin/api/index.ts
    frontend/src/features/admin/hooks/index.ts
    frontend/src/features/admin/components/UsageChart.tsx
    frontend/src/features/admin/components/UsageSummaryCards.tsx
    frontend/src/features/admin/components/AuditLogList.tsx
    frontend/src/pages/AdminAnalytics.tsx
    frontend/src/pages/AdminAuditLogs.tsx
    frontend/src/router.tsx
    frontend/src/components/layout/RootLayout.tsx
  </files>
  <action>
1. Add types to types.ts:
   - UsageSummary, UsageByUser, UsageByItem, UsageTimeline
   - AuditLog: { id, user_id, user_email, action, resource_type, resource_id, details, created_at }

2. Add API functions:
   - fetchUsageSummary(startDate?, endDate?)
   - fetchUsageByUser(startDate?, endDate?, limit?)
   - fetchUsageByItem(startDate?, endDate?, itemType?, limit?)
   - fetchUsageTimeline(startDate?, endDate?, granularity?)
   - fetchAuditLogs(page, pageSize, filters?)

3. Add hooks:
   - useUsageSummary, useUsageByUser, useUsageByItem, useUsageTimeline
   - useAuditLogs(page, pageSize, filters)

4. Create UsageSummaryCards.tsx:
   - Grid of stat cards showing: Total Users, Total Syncs, Active Users (this period)
   - Use shadcn Card component

5. Create UsageChart.tsx:
   - Line chart showing usage over time (use recharts - already in project likely, or add)
   - Date range picker at top
   - Responsive, shows skeleton while loading

6. Create AuditLogList.tsx:
   - Table with: Time, User, Action, Resource, Details (expandable)
   - Filters: resource_type dropdown, action dropdown, user search
   - Pagination
   - Click row to expand details JSON

7. Create pages/AdminAnalytics.tsx:
   - Date range picker at top
   - Summary cards
   - Usage timeline chart
   - Top users table
   - Top items table

8. Create pages/AdminAuditLogs.tsx:
   - Title "Audit Logs"
   - Filter controls
   - AuditLogList component

9. Update router.tsx: Add /admin/analytics, /admin/audit routes

10. Update RootLayout.tsx: Add Analytics, Audit Logs to admin nav
  </action>
  <verify>
    cd /Users/roysarfati/PycharmProjects/atlas/frontend && npm run build 2>&1 | head -20
  </verify>
  <done>Analytics dashboard and audit log viewer UI complete</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete admin panel with team management, user management, usage analytics, and audit logs</what-built>
  <how-to-verify>
1. Start backend: `cd backend && uv run uvicorn atlas.entrypoints.app:app --reload`
2. Start frontend: `cd frontend && npm run dev`
3. Login as admin user (may need to manually set role in DB: UPDATE users SET role='admin' WHERE email='your@email.com')
4. Navigate to /admin/teams:
   - Create a new team
   - Edit the team name
   - Add a user to the team
   - Remove the user
   - Delete the team
5. Navigate to /admin/users:
   - View user list
   - Try to change a user's role
   - Verify you cannot delete yourself
6. Navigate to /admin/analytics:
   - View summary cards
   - Check timeline chart renders
7. Navigate to /admin/audit:
   - View audit log entries from your actions
   - Try filters
8. Logout, login as regular user (role='user')
   - Verify admin nav doesn't appear
   - Try navigating to /admin/teams directly - should redirect or show 403
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues found</resume-signal>
</task>

</tasks>

<verification>
1. Backend tests pass (if any added)
2. Frontend builds without errors
3. Analytics endpoints return data
4. Charts render correctly
5. Audit log viewer shows entries
6. Date filtering works
7. All admin routes protected from regular users
</verification>

<success_criteria>
- Admin can view usage summary with key metrics
- Admin can see usage timeline chart
- Admin can see top users and top items
- Admin can browse and filter audit logs
- Audit log shows action details when expanded
- Date range filtering works on analytics
- Admin navigation includes all 4 sections: Teams, Users, Analytics, Audit Logs
- Non-admins cannot access admin pages
</success_criteria>

<output>
After completion, create `.planning/phases/09-governance-admin/09-05-SUMMARY.md`
</output>
