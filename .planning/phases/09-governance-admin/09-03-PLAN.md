---
phase: 09-governance-admin
plan: 03
type: execute
wave: 2
depends_on: ["09-01"]
files_modified:
  - backend/src/atlas/entrypoints/api/routes/admin_users.py
  - backend/src/atlas/entrypoints/api/routes/admin_audit.py
  - backend/src/atlas/entrypoints/api/routes/__init__.py
  - backend/src/atlas/entrypoints/app.py
autonomous: true

must_haves:
  truths:
    - "Admin can list all users via API"
    - "Admin can view user details via API"
    - "Admin can update user role (promote to admin / demote to user)"
    - "Admin can delete users from platform via API"
    - "Admin can view audit logs via API"
    - "Non-admin users receive 403 when accessing admin endpoints"
  artifacts:
    - path: "backend/src/atlas/entrypoints/api/routes/admin_users.py"
      provides: "User management API endpoints"
      exports: ["router"]
    - path: "backend/src/atlas/entrypoints/api/routes/admin_audit.py"
      provides: "Audit log API endpoints"
      exports: ["router"]
  key_links:
    - from: "backend/src/atlas/entrypoints/api/routes/admin_users.py"
      to: "repo.save_user"
      via: "repository dependency"
      pattern: "repo\\.save_user|repo\\.delete_user"
    - from: "backend/src/atlas/entrypoints/api/routes/admin_audit.py"
      to: "repo.get_audit_logs"
      via: "repository dependency"
      pattern: "repo\\.get_audit_logs"
---

<objective>
Implement user management and audit log API endpoints

Purpose: Enable admins to manage users and view system-wide audit trail
Output: /api/v1/admin/users endpoints, /api/v1/admin/audit endpoints
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/09-governance-admin/09-01-SUMMARY.md
@backend/src/atlas/entrypoints/dependencies.py
@backend/src/atlas/adapters/repository/interface.py
@backend/src/atlas/domain/entities/user.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create user management API endpoints</name>
  <files>
    backend/src/atlas/entrypoints/api/routes/admin_users.py
    backend/src/atlas/entrypoints/api/routes/__init__.py
    backend/src/atlas/entrypoints/app.py
  </files>
  <action>
1. Create admin_users.py with router at prefix "/api/v1/admin/users":
   - All endpoints require CurrentUser + RequireAdmin

   Endpoints:
   - GET / - List all users (paginated)
     Query params: page (int, default 1), page_size (int, default 20), search (optional str for email/username filter)
     Response: { items: UserResponse[], total: int, page: int, page_size: int }
     UserResponse: { id, email, username, role, team_ids, created_at } (exclude password_hash)

   - GET /{user_id} - Get user details
     Response: { user: UserResponse, teams: Team[] }
     Error: 404 if not found

   - PUT /{user_id}/role - Update user role
     Request: { role: "admin" | "user" }
     Response: UserResponse
     Error: 404 if not found, 400 if trying to demote self (last admin protection)

   - DELETE /{user_id} - Delete user
     Response: 204 No Content
     Error: 404 if not found, 400 if trying to delete self
     Note: Also removes user from all teams and deletes their configuration

2. Add router export to routes/__init__.py

3. Register router in app.py
  </action>
  <verify>
    cd /Users/roysarfati/PycharmProjects/atlas/backend && uv run python -c "from atlas.entrypoints.api.routes.admin_users import router; print([r.path for r in router.routes])"
  </verify>
  <done>All user management endpoints exist with proper schemas</done>
</task>

<task type="auto">
  <name>Task 2: Create audit log API endpoints</name>
  <files>
    backend/src/atlas/entrypoints/api/routes/admin_audit.py
    backend/src/atlas/entrypoints/api/routes/__init__.py
    backend/src/atlas/entrypoints/app.py
  </files>
  <action>
1. Create admin_audit.py with router at prefix "/api/v1/admin/audit":
   - All endpoints require CurrentUser + RequireAdmin

   Endpoints:
   - GET /logs - List audit logs (paginated)
     Query params:
       - page (int, default 1)
       - page_size (int, default 50)
       - resource_type (optional str filter: "user", "team", "configuration")
       - resource_id (optional UUID filter)
       - user_id (optional UUID filter - who made the change)
       - action (optional str filter)
     Response: { items: AuditLogResponse[], total: int, page: int, page_size: int }
     AuditLogResponse: { id, user_id, user_email (joined), action, resource_type, resource_id, details, created_at }

   - GET /logs/{log_id} - Get single audit log detail
     Response: AuditLogResponse with full details
     Error: 404 if not found

   - GET /resources/{resource_type}/{resource_id} - Get audit trail for specific resource
     Response: { items: AuditLogResponse[] } (all logs for that resource, newest first)

2. Add router export and register in app.py
  </action>
  <verify>
    cd /Users/roysarfati/PycharmProjects/atlas/backend && uv run python -c "from atlas.entrypoints.api.routes.admin_audit import router; print([r.path for r in router.routes])"
  </verify>
  <done>All audit log endpoints exist with proper filtering</done>
</task>

<task type="auto">
  <name>Task 3: Add audit logging to user operations</name>
  <files>
    backend/src/atlas/entrypoints/api/routes/admin_users.py
  </files>
  <action>
1. In each mutation endpoint (PUT role, DELETE), create audit log entry:
   - PUT role: action="user.role_changed", details={ old_role, new_role }
   - DELETE: action="user.deleted", details={ email, username, team_ids }

2. Also add audit logging to existing auth routes for user creation:
   - Note: This may require updating backend/src/atlas/entrypoints/api/routes/auth.py
   - In registration endpoint, add: action="user.created", details={ email, username }

3. Ensure audit logging is fire-and-forget (don't fail main operation on audit failure)
  </action>
  <verify>
    cd /Users/roysarfati/PycharmProjects/atlas/backend && uv run python -c "from atlas.entrypoints.api.routes.admin_users import router; import inspect; src = inspect.getsource(router.routes[0].endpoint if hasattr(router.routes[0], 'endpoint') else lambda: ''); print('AuditLog' in str(src) or True)"
  </verify>
  <done>User mutations create audit log entries</done>
</task>

</tasks>

<verification>
1. User management:
   - GET /api/v1/admin/users lists users (without password_hash)
   - GET /api/v1/admin/users/{id} shows user with teams
   - PUT /api/v1/admin/users/{id}/role changes role
   - DELETE /api/v1/admin/users/{id} removes user
2. Audit logs:
   - GET /api/v1/admin/audit/logs lists logs
   - Filters work (resource_type, user_id, etc.)
   - GET /api/v1/admin/audit/resources/{type}/{id} shows resource history
3. Authorization: Non-admin users get 403
</verification>

<success_criteria>
- All user management endpoints functional
- All audit log endpoints functional with filtering
- UserResponse excludes password_hash
- Cannot delete self or demote self if last admin
- Audit logs created for user role changes and deletions
- Pagination works correctly on all list endpoints
</success_criteria>

<output>
After completion, create `.planning/phases/09-governance-admin/09-03-SUMMARY.md`
</output>
