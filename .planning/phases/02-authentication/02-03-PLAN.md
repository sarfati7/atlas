---
phase: 02-authentication
plan: 03
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - backend/src/atlas/domain/interfaces/email_service.py
  - backend/src/atlas/domain/interfaces/__init__.py
  - backend/src/atlas/adapters/email/__init__.py
  - backend/src/atlas/adapters/email/console_email_service.py
  - backend/src/atlas/adapters/email/smtp_email_service.py
  - backend/src/atlas/entrypoints/dependencies.py
  - backend/src/atlas/entrypoints/api/routes/auth.py
  - backend/src/atlas/config.py
  - backend/pyproject.toml
autonomous: true

must_haves:
  truths:
    - "User can request password reset via email"
    - "User receives email with reset link (or console output in dev)"
    - "User can reset password with valid token"
    - "Reset token expires after 30 minutes"
    - "Same response returned whether email exists or not (no enumeration)"
  artifacts:
    - path: "backend/src/atlas/domain/interfaces/email_service.py"
      provides: "Abstract email service contract"
      exports: ["AbstractEmailService"]
    - path: "backend/src/atlas/adapters/email/console_email_service.py"
      provides: "Console output for dev/test"
      exports: ["ConsoleEmailService"]
    - path: "backend/src/atlas/entrypoints/api/routes/auth.py"
      provides: "forgot-password and reset-password endpoints"
      contains: "@router.post(\"/forgot-password\")"
  key_links:
    - from: "routes/auth.py forgot-password"
      to: "jwt_auth_service.create_password_reset_token"
      via: "itsdangerous serializer"
      pattern: "auth_service.create_password_reset_token"
    - from: "routes/auth.py forgot-password"
      to: "email_service.send_password_reset"
      via: "dependency injection"
      pattern: "email_service.send_password_reset"
    - from: "routes/auth.py reset-password"
      to: "jwt_auth_service.verify_password_reset_token"
      via: "itsdangerous verification"
      pattern: "auth_service.verify_password_reset_token"
---

<objective>
Implement password reset flow with email delivery.

Purpose: Enable users to recover access when they forget their password. Uses itsdangerous for secure, time-limited tokens that don't require database storage.

Output: Working forgot-password and reset-password endpoints with email notification.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-authentication/02-RESEARCH.md

# Depends on 02-01 output (auth service with reset token methods)
@.planning/phases/02-authentication/02-01-SUMMARY.md

# Code to extend
@backend/src/atlas/entrypoints/api/routes/auth.py
@backend/src/atlas/entrypoints/dependencies.py
@backend/src/atlas/adapters/auth/jwt_auth_service.py
@backend/src/atlas/config.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create email service interface and implementations</name>
  <files>
    - backend/pyproject.toml
    - backend/src/atlas/domain/interfaces/email_service.py
    - backend/src/atlas/domain/interfaces/__init__.py
    - backend/src/atlas/adapters/email/__init__.py
    - backend/src/atlas/adapters/email/console_email_service.py
    - backend/src/atlas/config.py
  </files>
  <action>
1. Add fastapi-mail to pyproject.toml:
   - fastapi-mail>=1.6.0

2. Create AbstractEmailService interface (domain/interfaces/email_service.py):
   - @abstractmethod async def send_password_reset(self, to_email: str, reset_url: str) -> None
   - Keep interface minimal - just what's needed for password reset

3. Export AbstractEmailService from domain/interfaces/__init__.py

4. Create adapters/email/__init__.py (package marker)

5. Create ConsoleEmailService (adapters/email/console_email_service.py):
   - Implements AbstractEmailService
   - send_password_reset prints to console:
     ```
     ========== PASSWORD RESET EMAIL ==========
     To: {to_email}
     Reset URL: {reset_url}
     ==========================================
     ```
   - Useful for development and testing without SMTP

6. Update config.py with email settings:
   - smtp_host: Optional[str] = None
   - smtp_port: int = 587
   - smtp_user: Optional[str] = None
   - smtp_password: Optional[str] = None
   - email_from: str = "noreply@atlas.local"
  </action>
  <verify>
cd /Users/roysarfati/PycharmProjects/atlas/backend && uv sync && python -c "
from atlas.domain.interfaces import AbstractEmailService
from atlas.adapters.email.console_email_service import ConsoleEmailService
import asyncio

async def test():
    svc = ConsoleEmailService()
    await svc.send_password_reset('test@example.com', 'http://localhost/reset?token=abc')
    print('Console email service works')

asyncio.run(test())
"
  </verify>
  <done>
- AbstractEmailService interface with send_password_reset method
- ConsoleEmailService prints email to console for dev/test
- Email settings added to config.py
- fastapi-mail added to dependencies
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement password reset endpoints</name>
  <files>
    - backend/src/atlas/entrypoints/dependencies.py
    - backend/src/atlas/entrypoints/api/routes/auth.py
  </files>
  <action>
1. Add email service dependency to dependencies.py:
   - get_email_service() -> AbstractEmailService
   - Returns ConsoleEmailService (always for now - SMTP impl is optional)
   - Create EmailSvc type alias

2. Add request/response models to auth.py:
   - ForgotPasswordRequest(email: EmailStr)
   - ResetPasswordRequest(token: str, new_password: str)

3. POST /forgot-password endpoint:
   - Rate limit: @limiter.limit("3/minute") (prevent abuse)
   - Accept ForgotPasswordRequest
   - Fetch user by email
   - If user exists:
     - Generate reset token: auth_service.create_password_reset_token(email)
     - Build reset URL: f"{settings.frontend_url}/reset-password?token={token}"
     - Send email: await email_service.send_password_reset(email, reset_url)
   - ALWAYS return same response: {"message": "If that email is registered, you will receive a reset link"}
   - This prevents email enumeration attacks

4. POST /reset-password endpoint:
   - Rate limit: @limiter.limit("5/minute")
   - Accept ResetPasswordRequest
   - Validate new_password using Password value object (8+ chars)
   - Verify token: email = auth_service.verify_password_reset_token(token, max_age_seconds=1800)
   - If None: raise 400 "Invalid or expired reset token"
   - Fetch user by email
   - If not found: raise 400 "Invalid or expired reset token" (same message)
   - Hash new password: auth_service.hash_password(new_password)
   - Update user.password_hash
   - Save via user_repo.save(user)
   - Return: {"message": "Password successfully reset"}
  </action>
  <verify>
cd /Users/roysarfati/PycharmProjects/atlas/backend && python -c "
from atlas.entrypoints.api.routes.auth import router
routes = {r.path: r.methods for r in router.routes if hasattr(r, 'methods')}
print('Auth routes:', routes)
assert '/forgot-password' in routes, 'forgot-password missing'
assert '/reset-password' in routes, 'reset-password missing'
print('Password reset endpoints created')
"
  </verify>
  <done>
- POST /forgot-password generates reset token and sends email
- Returns same response whether email exists or not
- POST /reset-password validates token and updates password
- Token expires after 30 minutes
- Rate limiting on both endpoints
- Password validation enforced on new password
  </done>
</task>

<task type="auto">
  <name>Task 3: Add optional SMTP email service</name>
  <files>
    - backend/src/atlas/adapters/email/smtp_email_service.py
    - backend/src/atlas/entrypoints/dependencies.py
  </files>
  <action>
1. Create SMTPEmailService (adapters/email/smtp_email_service.py):
   - Implements AbstractEmailService
   - Uses fastapi-mail for async SMTP
   - Constructor takes smtp settings from config
   - send_password_reset creates simple HTML email:
     ```
     Subject: Reset Your Atlas Password
     Body: Click here to reset your password: {reset_url}
           This link expires in 30 minutes.
     ```
   - Handle connection errors gracefully (log error, don't crash)

2. Update get_email_service in dependencies.py:
   - If settings.smtp_host is configured: return SMTPEmailService
   - Otherwise: return ConsoleEmailService
   - Log which service is being used
  </action>
  <verify>
cd /Users/roysarfati/PycharmProjects/atlas/backend && python -c "
from atlas.adapters.email.smtp_email_service import SMTPEmailService
from atlas.entrypoints.dependencies import get_email_service
import asyncio

async def test():
    # Without SMTP config, should get Console
    svc = await get_email_service()
    print('Email service type:', type(svc).__name__)

asyncio.run(test())
"
  </verify>
  <done>
- SMTPEmailService uses fastapi-mail for real email delivery
- Conditional: SMTP if configured, Console otherwise
- Email contains reset link and expiry warning
- Connection errors handled gracefully
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. Password reset flow:
   - POST /forgot-password returns success (doesn't reveal if email exists)
   - Console shows reset URL (in dev mode)
2. Token verification:
   - Valid token within 30 min allows password reset
   - Expired/invalid token returns 400
3. Password update:
   - After reset, user can login with new password
</verification>

<success_criteria>
- AbstractEmailService interface in domain layer
- ConsoleEmailService for dev/test (prints to console)
- SMTPEmailService for production (uses fastapi-mail)
- POST /forgot-password generates time-limited token
- Same response returned whether email exists or not
- POST /reset-password validates token and updates password
- Token expires after 30 minutes (1800 seconds)
- New password must meet validation rules (8+ chars)
- Rate limiting on both endpoints
</success_criteria>

<output>
After completion, create `.planning/phases/02-authentication/02-03-SUMMARY.md`
</output>
