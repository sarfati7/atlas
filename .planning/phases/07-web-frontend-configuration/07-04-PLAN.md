---
phase: 07-web-frontend-configuration
plan: 04
type: execute
wave: 2
depends_on: ["07-01", "07-02"]
files_modified:
  - frontend/src/features/configuration/components/VersionDetail.tsx
  - frontend/src/features/configuration/components/HistoryTab.tsx
  - frontend/src/routes/settings.tsx
  - frontend/src/features/configuration/index.ts
autonomous: true

must_haves:
  truths:
    - "User can view list of previous versions"
    - "User can click version to see its metadata (message, author, date, SHA)"
    - "User sees confirmation before rollback with version metadata"
    - "User can rollback to a previous version"
    - "Rollback shows success toast and updates editor"
  artifacts:
    - path: "frontend/src/features/configuration/components/VersionDetail.tsx"
      provides: "Version metadata display with rollback confirmation"
      exports: ["VersionDetail"]
    - path: "frontend/src/features/configuration/components/HistoryTab.tsx"
      provides: "History tab with version list and detail view"
      exports: ["HistoryTab"]
  key_links:
    - from: "VersionDetail.tsx"
      to: "useRollback"
      via: "mutation for rollback"
      pattern: "useRollback\\(\\)"
    - from: "HistoryTab.tsx"
      to: "VersionHistory"
      via: "renders version list"
      pattern: "<VersionHistory"
    - from: "settings.tsx"
      to: "HistoryTab"
      via: "renders in History tab"
      pattern: "<HistoryTab"
---

<objective>
Complete the History tab with version detail view (metadata-based) and rollback functionality.

Purpose: Users need to see their configuration version history and be able to rollback to any previous version. Since the backend does not have an endpoint to fetch historical version content, we show version METADATA (commit message, author, timestamp, SHA) for confirmation before rollback. After rollback completes, the editor shows the restored content.

Output:
- VersionDetail component showing version metadata with rollback confirmation
- HistoryTab component managing list/detail navigation
- History tab in Settings with full rollback flow
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/07-web-frontend-configuration/07-CONTEXT.md

# Components from earlier plans
@frontend/src/features/configuration/components/VersionHistory.tsx
@frontend/src/routes/settings.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create VersionDetail component with metadata display</name>
  <files>
    frontend/src/features/configuration/components/VersionDetail.tsx
  </files>
  <action>
Create `frontend/src/features/configuration/components/VersionDetail.tsx`:

```typescript
import { useState } from 'react'
import { formatDistanceToNow, format } from 'date-fns'
import { ArrowLeft, RotateCcw, Check, Calendar, User, GitCommit, MessageSquare } from 'lucide-react'
import { Button } from '@/components/ui/button'
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from '@/components/ui/card'
import {
  AlertDialog,
  AlertDialogAction,
  AlertDialogCancel,
  AlertDialogContent,
  AlertDialogDescription,
  AlertDialogFooter,
  AlertDialogHeader,
  AlertDialogTitle,
} from '@/components/ui/alert-dialog'
import { useRollback } from '../hooks/useConfiguration'
import type { Version } from '../types'

interface VersionDetailProps {
  version: Version
  isLatest: boolean
  onBack: () => void
  onRollbackSuccess: () => void
}

export function VersionDetail({
  version,
  isLatest,
  onBack,
  onRollbackSuccess,
}: VersionDetailProps) {
  const rollback = useRollback()
  const [showConfirm, setShowConfirm] = useState(false)
  const [showSuccess, setShowSuccess] = useState(false)

  const handleRollback = () => {
    setShowConfirm(false)
    rollback.mutate(version.commit_sha, {
      onSuccess: () => {
        setShowSuccess(true)
        // Brief success message, then navigate back
        setTimeout(() => {
          onRollbackSuccess()
        }, 1500)
      },
    })
  }

  return (
    <div className="space-y-4">
      {/* Header with back button */}
      <div className="flex items-center gap-4">
        <Button variant="ghost" size="sm" onClick={onBack} className="gap-2">
          <ArrowLeft className="h-4 w-4" />
          Back to history
        </Button>
      </div>

      {/* Version metadata card */}
      <Card>
        <CardHeader>
          <div className="flex items-start justify-between">
            <div>
              <CardTitle className="text-lg flex items-center gap-2">
                <MessageSquare className="h-4 w-4 text-muted-foreground" />
                {version.message || 'Configuration update'}
              </CardTitle>
              <CardDescription className="mt-2">
                {isLatest ? 'This is your current configuration.' : 'You can restore this version to replace your current configuration.'}
              </CardDescription>
            </div>

            {isLatest ? (
              <span className="text-sm font-medium text-primary bg-primary/10 px-3 py-1 rounded-full">
                Current version
              </span>
            ) : showSuccess ? (
              <Button variant="outline" disabled className="gap-2">
                <Check className="h-4 w-4 text-primary" />
                Restored
              </Button>
            ) : (
              <Button
                onClick={() => setShowConfirm(true)}
                disabled={rollback.isPending}
                className="gap-2"
              >
                <RotateCcw className="h-4 w-4" />
                {rollback.isPending ? 'Restoring...' : 'Restore this version'}
              </Button>
            )}
          </div>
        </CardHeader>
        <CardContent>
          {/* Version metadata details */}
          <div className="grid gap-4 sm:grid-cols-2">
            <div className="flex items-start gap-3">
              <User className="h-4 w-4 text-muted-foreground mt-0.5" />
              <div>
                <p className="text-sm font-medium">Author</p>
                <p className="text-sm text-muted-foreground">{version.author}</p>
              </div>
            </div>

            <div className="flex items-start gap-3">
              <Calendar className="h-4 w-4 text-muted-foreground mt-0.5" />
              <div>
                <p className="text-sm font-medium">Date</p>
                <p className="text-sm text-muted-foreground">
                  {format(new Date(version.timestamp), 'PPpp')}
                </p>
                <p className="text-xs text-muted-foreground">
                  ({formatDistanceToNow(new Date(version.timestamp), { addSuffix: true })})
                </p>
              </div>
            </div>

            <div className="flex items-start gap-3 sm:col-span-2">
              <GitCommit className="h-4 w-4 text-muted-foreground mt-0.5" />
              <div>
                <p className="text-sm font-medium">Commit SHA</p>
                <code className="text-sm text-muted-foreground font-mono bg-muted px-2 py-0.5 rounded">
                  {version.commit_sha}
                </code>
              </div>
            </div>
          </div>

          {rollback.error && (
            <p className="text-sm text-destructive mt-4">
              Failed to restore version. Please try again.
            </p>
          )}
        </CardContent>
      </Card>

      {/* What happens notice */}
      {!isLatest && !showSuccess && (
        <Card className="border-muted">
          <CardContent className="py-4">
            <p className="text-sm text-muted-foreground">
              <strong>What happens when you restore:</strong> A new commit will be created with the content from this version. Your current configuration will be replaced, and you can always rollback again if needed.
            </p>
          </CardContent>
        </Card>
      )}

      {/* Rollback confirmation dialog */}
      <AlertDialog open={showConfirm} onOpenChange={setShowConfirm}>
        <AlertDialogContent>
          <AlertDialogHeader>
            <AlertDialogTitle>Restore this version?</AlertDialogTitle>
            <AlertDialogDescription className="space-y-2">
              <p>
                You are about to restore your configuration to the version from{' '}
                <strong>{format(new Date(version.timestamp), 'PPp')}</strong>.
              </p>
              <p className="text-xs">
                Commit: <code className="bg-muted px-1 rounded">{version.commit_sha.slice(0, 7)}</code>
              </p>
              <p>
                This will replace your current configuration. You can always rollback again if needed.
              </p>
            </AlertDialogDescription>
          </AlertDialogHeader>
          <AlertDialogFooter>
            <AlertDialogCancel>Cancel</AlertDialogCancel>
            <AlertDialogAction onClick={handleRollback}>
              Restore version
            </AlertDialogAction>
          </AlertDialogFooter>
        </AlertDialogContent>
      </AlertDialog>
    </div>
  )
}
```

Note: This component shows version METADATA (message, author, date, SHA) instead of trying to fetch historical content. The confirmation dialog explains what will happen. After rollback, the user sees the restored content in the editor.
  </action>
  <verify>
`cd frontend && npx tsc --noEmit` passes
Component shows metadata fields (author, date, SHA)
Component has rollback confirmation dialog
  </verify>
  <done>
VersionDetail shows:
- Version metadata (message, author, date, full SHA)
- Explanation of what restore does
- Confirmation dialog before rollback
- Restore button (hidden for current version)
- Success state with brief "Restored" message
  </done>
</task>

<task type="auto">
  <name>Task 2: Create HistoryTab component and integrate with Settings</name>
  <files>
    frontend/src/features/configuration/components/HistoryTab.tsx
    frontend/src/features/configuration/index.ts
    frontend/src/routes/settings.tsx
  </files>
  <action>
Create `frontend/src/features/configuration/components/HistoryTab.tsx`:

```typescript
import { useState } from 'react'
import {
  AlertDialog,
  AlertDialogAction,
  AlertDialogCancel,
  AlertDialogContent,
  AlertDialogDescription,
  AlertDialogFooter,
  AlertDialogHeader,
  AlertDialogTitle,
} from '@/components/ui/alert-dialog'
import { VersionHistory } from './VersionHistory'
import { VersionDetail } from './VersionDetail'
import { useConfiguration } from '../hooks/useConfiguration'
import type { Version } from '../types'

interface HistoryTabProps {
  isDirty: boolean
  onRollbackSuccess: () => void
}

export function HistoryTab({ isDirty, onRollbackSuccess }: HistoryTabProps) {
  const { data: config } = useConfiguration()
  const [selectedVersion, setSelectedVersion] = useState<Version | null>(null)
  const [showDirtyWarning, setShowDirtyWarning] = useState(false)
  const [pendingVersion, setPendingVersion] = useState<Version | null>(null)

  const currentCommitSha = config?.commit_sha

  const handleVersionSelect = (version: Version) => {
    // If dirty, warn user first
    if (isDirty) {
      setPendingVersion(version)
      setShowDirtyWarning(true)
      return
    }

    setSelectedVersion(version)
  }

  const handleDirtyWarningConfirm = () => {
    setShowDirtyWarning(false)
    if (pendingVersion) {
      setSelectedVersion(pendingVersion)
      setPendingVersion(null)
    }
  }

  const handleBack = () => {
    setSelectedVersion(null)
  }

  const handleRollbackSuccess = () => {
    setSelectedVersion(null)
    onRollbackSuccess()
  }

  // Determine if selected version is the current version
  const isLatest = selectedVersion
    ? currentCommitSha === selectedVersion.commit_sha
    : false

  if (selectedVersion) {
    return (
      <VersionDetail
        version={selectedVersion}
        isLatest={isLatest}
        onBack={handleBack}
        onRollbackSuccess={handleRollbackSuccess}
      />
    )
  }

  return (
    <>
      <VersionHistory
        currentCommitSha={currentCommitSha}
        onVersionSelect={handleVersionSelect}
      />

      <AlertDialog open={showDirtyWarning} onOpenChange={setShowDirtyWarning}>
        <AlertDialogContent>
          <AlertDialogHeader>
            <AlertDialogTitle>Unsaved changes</AlertDialogTitle>
            <AlertDialogDescription>
              You have unsaved changes in the editor. Viewing a previous version
              will not discard your changes, but rolling back will replace your
              current content.
            </AlertDialogDescription>
          </AlertDialogHeader>
          <AlertDialogFooter>
            <AlertDialogCancel onClick={() => setPendingVersion(null)}>
              Cancel
            </AlertDialogCancel>
            <AlertDialogAction onClick={handleDirtyWarningConfirm}>
              Continue
            </AlertDialogAction>
          </AlertDialogFooter>
        </AlertDialogContent>
      </AlertDialog>
    </>
  )
}
```

Update `frontend/src/features/configuration/index.ts` to export new components:

Add:
```typescript
export { VersionDetail } from './components/VersionDetail'
export { HistoryTab } from './components/HistoryTab'
```

Update `frontend/src/routes/settings.tsx` History tab:

1. Import HistoryTab:
```typescript
import {
  ConfigurationEditor,
  useConfiguration,
  useUpdateConfiguration,
  useImportConfiguration,
  useDraftStore,
  HistoryTab,
} from '@/features/configuration'
```

2. Replace History TabsContent:

Change from:
```typescript
<TabsContent value="history">
  <div className="text-muted-foreground py-12 text-center">
    History tab (coming in Plan 07-04)
  </div>
</TabsContent>
```

To:
```typescript
<TabsContent value="history">
  <HistoryTab
    isDirty={isDirty}
    onRollbackSuccess={() => {
      // After rollback, refresh config and reset draft
      refetch()
    }}
  />
</TabsContent>
```
  </action>
  <verify>
`cd frontend && npx tsc --noEmit` passes
HistoryTab renders VersionHistory and handles version selection
isLatest correctly compares version.commit_sha with config.commit_sha
  </verify>
  <done>
HistoryTab component:
- Shows VersionHistory list with currentCommitSha for isLatest detection
- On version click, shows VersionDetail with metadata
- Properly determines isLatest by comparing SHA with current config
- Warns if clicking version with unsaved editor changes
- On rollback success, returns to list and refreshes
  </done>
</task>

<task type="auto">
  <name>Task 3: Add AlertDialog UI component</name>
  <files>
    frontend/src/components/ui/alert-dialog.tsx
  </files>
  <action>
Check if AlertDialog exists:
```bash
ls frontend/src/components/ui/alert-dialog.tsx 2>/dev/null || echo "needs creation"
```

If it doesn't exist, add it via shadcn:
```bash
cd frontend && npx shadcn@latest add alert-dialog
```

This adds the AlertDialog component from shadcn/ui, which is used for the dirty warning dialog and rollback confirmation dialog.
  </action>
  <verify>
`ls frontend/src/components/ui/alert-dialog.tsx` shows file exists
  </verify>
  <done>
AlertDialog component available for confirmation dialogs
  </done>
</task>

</tasks>

<verification>
Full history flow works:
```bash
cd frontend && npx tsc --noEmit
```

Manual verification:
1. Go to /settings, click History tab
2. See list of versions (or empty state)
3. Click a version - see detail view with metadata (message, author, date, SHA)
4. Click "Restore this version" - see confirmation dialog
5. Confirm - config is rolled back
6. See "Restored" success, then navigates back to list
7. Editor tab now shows restored content
</verification>

<success_criteria>
1. VersionDetail shows version metadata (message, author, date, SHA)
2. VersionDetail has confirmation dialog before rollback
3. Rollback button triggers useRollback mutation
4. Success state shows briefly before navigating back
5. HistoryTab manages list/detail state
6. isLatest correctly determined by comparing version SHA with config.commit_sha
7. Dirty warning appears when clicking version with unsaved changes
8. Settings page History tab renders HistoryTab
9. AlertDialog component available
</success_criteria>

<output>
After completion, create `.planning/phases/07-web-frontend-configuration/07-04-SUMMARY.md`
</output>
