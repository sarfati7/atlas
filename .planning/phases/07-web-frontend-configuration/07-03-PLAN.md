---
phase: 07-web-frontend-configuration
plan: 03
type: execute
wave: 2
depends_on: ["07-01", "07-02"]
files_modified:
  - frontend/src/features/configuration/stores/draftStore.ts
  - frontend/src/routes/settings.tsx
  - frontend/src/routes/router.tsx
autonomous: true

must_haves:
  truths:
    - "User can see and edit their configuration in Monaco editor"
    - "User sees Save button that enables when changes exist"
    - "User sees Import button in toolbar alongside Save"
    - "User is warned when navigating away with unsaved changes"
  artifacts:
    - path: "frontend/src/features/configuration/stores/draftStore.ts"
      provides: "Zustand store for draft state"
      exports: ["useDraftStore"]
    - path: "frontend/src/routes/settings.tsx"
      provides: "Settings page with editor and toolbar with Save + Import"
      exports: ["SettingsPage"]
  key_links:
    - from: "settings.tsx"
      to: "ConfigurationEditor"
      via: "import and render"
      pattern: "<ConfigurationEditor"
    - from: "settings.tsx"
      to: "useConfiguration"
      via: "hook for fetching config"
      pattern: "useConfiguration\\(\\)"
    - from: "settings.tsx"
      to: "draftStore.ts"
      via: "Zustand for dirty tracking"
      pattern: "useDraftStore"
---

<objective>
Create Settings page with Editor tab, save functionality, import button in toolbar, and dirty state tracking.

Purpose: Users need a place to edit their claude.md configuration. The Settings page hosts the Monaco editor with Save and Import buttons in the header toolbar, and unsaved changes warning. This is the core editing experience.

Output:
- Zustand store for draft state (content, isDirty)
- Settings page with Editor tab
- Header toolbar with Save and Import buttons
- beforeunload warning for unsaved changes
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/07-web-frontend-configuration/07-CONTEXT.md

# Existing patterns
@frontend/src/stores/authStore.ts
@frontend/src/routes/dashboard.tsx
@frontend/src/routes/router.tsx

# Components from 07-01 and 07-02
@frontend/src/features/configuration/components/ConfigurationEditor.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Zustand draft store</name>
  <files>
    frontend/src/features/configuration/stores/draftStore.ts
    frontend/src/features/configuration/index.ts
  </files>
  <action>
Create `frontend/src/features/configuration/stores/draftStore.ts`:

```typescript
import { create } from 'zustand'

interface DraftState {
  content: string
  originalContent: string
  isDirty: boolean

  setContent: (content: string) => void
  setOriginalContent: (content: string) => void
  resetDraft: () => void
  discardChanges: () => void
}

export const useDraftStore = create<DraftState>((set, get) => ({
  content: '',
  originalContent: '',
  isDirty: false,

  setContent: (content) => {
    const { originalContent } = get()
    set({
      content,
      isDirty: content !== originalContent,
    })
  },

  setOriginalContent: (content) => {
    set({
      originalContent: content,
      content,
      isDirty: false,
    })
  },

  resetDraft: () => {
    set({
      content: '',
      originalContent: '',
      isDirty: false,
    })
  },

  discardChanges: () => {
    const { originalContent } = get()
    set({
      content: originalContent,
      isDirty: false,
    })
  },
}))
```

Update `frontend/src/features/configuration/index.ts` to export store:

Add this export:
```typescript
export { useDraftStore } from './stores/draftStore'
```
  </action>
  <verify>
`cd frontend && npx tsc --noEmit` passes
Store exports isDirty computed from content vs originalContent
  </verify>
  <done>
Draft store tracks content, originalContent, and computed isDirty
Actions: setContent, setOriginalContent, resetDraft, discardChanges
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Settings page with Editor tab and Import button in toolbar</name>
  <files>
    frontend/src/routes/settings.tsx
  </files>
  <action>
Create `frontend/src/routes/settings.tsx`:

```typescript
import { useEffect, useRef } from 'react'
import { Save, AlertTriangle, Upload } from 'lucide-react'
import { Button } from '@/components/ui/button'
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs'
import { Card, CardContent } from '@/components/ui/card'
import { Skeleton } from '@/components/ui/skeleton'
import {
  ConfigurationEditor,
  useConfiguration,
  useUpdateConfiguration,
  useImportConfiguration,
  useDraftStore,
} from '@/features/configuration'

function EditorSkeleton() {
  return (
    <div className="space-y-4">
      <Skeleton className="h-[500px] w-full rounded-lg" />
    </div>
  )
}

function EditorError({ onRetry }: { onRetry: () => void }) {
  return (
    <Card className="border-destructive/50 bg-destructive/10">
      <CardContent className="flex items-center gap-4 py-4">
        <AlertTriangle className="h-5 w-5 text-destructive" />
        <div className="flex-1">
          <p className="text-sm text-destructive">Failed to load configuration</p>
        </div>
        <Button variant="outline" size="sm" onClick={onRetry}>
          Retry
        </Button>
      </CardContent>
    </Card>
  )
}

export function SettingsPage() {
  const { data: config, isLoading, error, refetch } = useConfiguration()
  const updateConfig = useUpdateConfiguration()
  const importConfig = useImportConfiguration()
  const fileInputRef = useRef<HTMLInputElement>(null)

  const { content, isDirty, setContent, setOriginalContent } = useDraftStore()

  // Sync server config to draft store on load
  useEffect(() => {
    if (config?.content !== undefined) {
      setOriginalContent(config.content)
    }
  }, [config?.content, setOriginalContent])

  // Warn on browser close/reload with unsaved changes
  useEffect(() => {
    const handleBeforeUnload = (e: BeforeUnloadEvent) => {
      if (isDirty) {
        e.preventDefault()
        e.returnValue = ''
      }
    }
    window.addEventListener('beforeunload', handleBeforeUnload)
    return () => window.removeEventListener('beforeunload', handleBeforeUnload)
  }, [isDirty])

  const handleSave = () => {
    updateConfig.mutate(
      { content },
      {
        onSuccess: (newConfig) => {
          setOriginalContent(newConfig.content)
        },
      }
    )
  }

  const handleImportClick = () => {
    fileInputRef.current?.click()
  }

  const handleFileChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0]
    if (file) {
      // Validate file type
      if (!file.name.endsWith('.md')) {
        // Reset input and ignore
        e.target.value = ''
        return
      }

      importConfig.mutate(file, {
        onSuccess: () => {
          refetch()
          e.target.value = '' // Reset for next import
        },
        onError: () => {
          e.target.value = '' // Reset on error too
        },
      })
    }
  }

  return (
    <div className="min-h-screen bg-background">
      <div className="container mx-auto max-w-5xl px-4 py-8">
        {/* Header with Save and Import buttons */}
        <header className="mb-6 flex items-center justify-between">
          <div>
            <h1 className="text-2xl font-semibold text-foreground">Settings</h1>
            <p className="text-muted-foreground">Manage your claude.md configuration</p>
          </div>
          <div className="flex items-center gap-2">
            {/* Hidden file input for import */}
            <input
              ref={fileInputRef}
              type="file"
              accept=".md"
              className="hidden"
              onChange={handleFileChange}
            />
            <Button
              variant="outline"
              onClick={handleImportClick}
              disabled={importConfig.isPending}
              className="gap-2"
            >
              <Upload className="h-4 w-4" />
              {importConfig.isPending ? 'Importing...' : 'Import'}
            </Button>
            <Button
              onClick={handleSave}
              disabled={!isDirty || updateConfig.isPending}
              className="gap-2"
            >
              <Save className="h-4 w-4" />
              {updateConfig.isPending ? 'Saving...' : 'Save'}
            </Button>
          </div>
        </header>

        {/* Dirty indicator */}
        {isDirty && (
          <div className="mb-4 flex items-center gap-2 text-sm text-amber-500">
            <div className="h-2 w-2 rounded-full bg-amber-500" />
            Unsaved changes
          </div>
        )}

        {/* Tabs */}
        <Tabs defaultValue="editor" className="space-y-4">
          <TabsList>
            <TabsTrigger value="editor">Editor</TabsTrigger>
            <TabsTrigger value="history">History</TabsTrigger>
            <TabsTrigger value="import">Import</TabsTrigger>
          </TabsList>

          <TabsContent value="editor">
            {error ? (
              <EditorError onRetry={refetch} />
            ) : isLoading ? (
              <EditorSkeleton />
            ) : (
              <ConfigurationEditor value={content} onChange={setContent} />
            )}
          </TabsContent>

          <TabsContent value="history">
            <div className="text-muted-foreground py-12 text-center">
              History tab (coming in Plan 07-04)
            </div>
          </TabsContent>

          <TabsContent value="import">
            <div className="text-muted-foreground py-12 text-center">
              Import tab (coming in Plan 07-05)
            </div>
          </TabsContent>
        </Tabs>
      </div>
    </div>
  )
}
```

Note: The Import button is placed in the header toolbar alongside Save as specified in CONTEXT.md. Clicking it opens a hidden file input for .md files. The Import tab will have a full dropzone experience in Plan 07-05, but the toolbar button provides quick access.
  </action>
  <verify>
`cd frontend && npx tsc --noEmit` passes
Page has header with Import and Save buttons
Editor tab shows Monaco editor
Import button triggers file picker for .md files
  </verify>
  <done>
Settings page with:
- Header showing title, Import button, and Save button
- Import button in toolbar triggers file picker (alongside Save)
- Save button disabled when not dirty or saving
- Dirty indicator when unsaved changes
- Editor/History/Import tabs (History and Import are placeholders)
- beforeunload warning for unsaved changes
  </done>
</task>

<task type="auto">
  <name>Task 3: Update router to use SettingsPage</name>
  <files>
    frontend/src/routes/router.tsx
  </files>
  <action>
Update `frontend/src/routes/router.tsx`:

1. Add import at top:
```typescript
import { SettingsPage } from './settings'
```

2. Replace the settings route placeholder:

Change from:
```typescript
{
  path: '/settings',
  element: <div className="p-6">Settings (coming later)</div>,
  loader: protectedLoader,
},
```

To:
```typescript
{
  path: '/settings',
  element: <SettingsPage />,
  loader: protectedLoader,
},
```
  </action>
  <verify>
`cd frontend && npx tsc --noEmit` passes
Settings route imports SettingsPage component
  </verify>
  <done>
Router updated to render SettingsPage at /settings
Route remains protected via protectedLoader
  </done>
</task>

</tasks>

<verification>
Full flow works:
```bash
cd frontend && npx tsc --noEmit
```

Manual verification:
1. Navigate to /settings (while logged in)
2. See Monaco editor with current config (or empty)
3. Edit content - Save button enables, dirty indicator shows
4. Save - button shows "Saving...", then success
5. Click Import button - file picker opens, accepts only .md files
6. Try to close tab with unsaved changes - browser warns
</verification>

<success_criteria>
1. Zustand store tracks content and isDirty state
2. Settings page fetches configuration on mount
3. Monaco editor shows current configuration
4. Save button disabled when no changes or saving
5. Import button in header toolbar opens file picker for .md files
6. Dirty indicator visible when unsaved changes exist
7. beforeunload warns when leaving with unsaved changes
8. Router updated to render SettingsPage
</success_criteria>

<output>
After completion, create `.planning/phases/07-web-frontend-configuration/07-03-SUMMARY.md`
</output>
